<!DOCTYPE html>
<html><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">

 <title>By example: Continuation-passing style in JavaScript 
</title>

 <link rel="alternate" type="application/rss+xml" title="RSS" href="http://matt.might.net/articles/feed.rss">

 <link rel="stylesheet" href="By%20example:%20Continuation-passing%20style%20in%20JavaScript_files/raised-paper-2.css"> 


 <meta name="viewport" content="width=480, initial-scale=1">
 <link rel="stylesheet" media="screen and (max-device-width: 480px)" href="By%20example:%20Continuation-passing%20style%20in%20JavaScript_files/raised-paper-2-handheld.css">

 <script src="By%20example:%20Continuation-passing%20style%20in%20JavaScript_files/ca-pub-4400645483943138.js"></script><script type="text/javascript" src="By%20example:%20Continuation-passing%20style%20in%20JavaScript_files/matt.js"></script>
 <script type="text/javascript">
  var ArticleVersion = 2 ;
 </script>
 <script>
 <!--
  include("article-style.js");
 //-->
 </script><script src="By%20example:%20Continuation-passing%20style%20in%20JavaScript_files/article-style.js"></script>
 <script type="text/javascript" src="By%20example:%20Continuation-passing%20style%20in%20JavaScript_files/manifest.js"></script>
 <script type="text/javascript" src="By%20example:%20Continuation-passing%20style%20in%20JavaScript_files/index-manifest.js"></script>

 <script type="text/javascript">
 <!--
//  var Key = "[an error occurred while processing the directive]";
 var Pathname = location.pathname ;
 var PathParts = Pathname.split(/\//) ;
 var Key = PathParts[PathParts.length-1] ;
 if (Key == "")
  Key = PathParts[PathParts.length-2] ;
 //-->
 </script>

</head>



<body>

<div id="body">







<div class="navlinks"><b>Latest:</b> <a href="http://matt.might.net/articles/tenure/">HOWTO: Get tenure</a><br><b>Next:</b> <a href="http://matt.might.net/articles/red-black-delete/">Deleting from Okasaki's red-black trees</a><br><b>Prev:</b> <a href="http://matt.might.net/articles/problem-shapes/">The shape of your problem</a><br><b>Rand:</b> <a href="http://matt.might.net/articles/perl-by-example/">Learn Perl by experiment</a></div><div id="abstract-container" class="module">
<div id="abstract-content" class="fat-content">

 <h1>By example: Continuation-passing style in JavaScript 
</h1>

 <div>
 [<a href="http://matt.might.net/articles/">article index</a>]
 [<script>
       var emailMatt = '<a href="mai'+'lto:matt-blog'+'@'+'migh'+'t.net">email me</a>'
document.write(emailMatt);
 //-->
</script><a href="mailto:matt-blog@might.net">email me</a>] 
 [<a href="http://twitter.com/mattmight">@mattmight</a>]
 [<a href="http://gplus.to/mattmight">+mattmight</a>]
 [<a href="http://matt.might.net/articles/feed.rss">rss</a>]
 </div>

 <p> Continuation-passing style (CPS) originated as a style of programming in
the 1970s, and it rose to prominence as an intermediate representation for
compilers of advanced programming languages in the 1980s and 1990s.  </p>

<p> It's now being rediscovered as a style of programming for
non-blocking (usually distributed) systems.  </p>

<p> There's a warm spot in my heart for CPS, because it was the secret weapon
in my Ph.D. 

It probably shaved off a couple years and immeasurable agony.
</p>


<p> This article introduces CPS in both of its roles--as a style for
non-blocking programming in JavaScript, and (briefly) as an intermediate form
for a functional language.  </p>

<p>
Topics covered:
</p>

<ul>
 <li>CPS in JavaScript</li>
 <li>CPS for Ajax programming</li>
 <li>CPS for non-blocking programming (in node.js)</li>
 <li>CPS for distributed programming</li>
 <li>How to implement exceptions using CPS</li>
 <li>A CPS converter for a minimal Lisp</li>
 <li>How to implement <code>call/cc</code> in Lisp</li>
 <li>How to implement <code>call/cc</code> in JavaScript</li>
</ul>

<p>
Read on for more.
</p>



  
</div> <!-- /#content -->
</div> <!-- /#content-container -->



<div class="module fat-container">
<div class="fat-content">

<center>

<script type="text/javascript"><!--
google_ad_client = "pub-4400645483943138";
/* Header ad unit */
google_ad_slot = "8276008011";
google_ad_width = 468;
google_ad_height = 60;
//-->
</script>
<script type="text/javascript" src="By%20example:%20Continuation-passing%20style%20in%20JavaScript_files/show_ads.js">
</script><ins id="aswift_0_expand" style="display:inline-table;border:none;height:60px;margin:0;padding:0;position:relative;visibility:visible;width:468px;background-color:transparent"><ins id="aswift_0_anchor" style="display:block;border:none;height:60px;margin:0;padding:0;position:relative;visibility:visible;width:468px;background-color:transparent"><iframe marginwidth="0" marginheight="0" vspace="0" hspace="0" allowtransparency="true" scrolling="no" allowfullscreen="true" onload="var i=this.id,s=window.google_iframe_oncopy,H=s&amp;&amp;s.handlers,h=H&amp;&amp;H[i],w=this.contentWindow,d;try{d=w.document}catch(e){}if(h&amp;&amp;d&amp;&amp;(!d.body||!d.body.firstChild)){if(h.call){setTimeout(h,0)}else if(h.match){try{h=s.upd(h,i)}catch(e){}w.location.replace(h)}}" id="aswift_0" name="aswift_0" style="left:0;position:absolute;top:0;" frameborder="0" height="60" width="468"></iframe></ins></ins>

</center>
  
</div>
</div>




  
<div id="content-container" class="module">
<div id="article-content">

  <script type="text/javascript">
<!--
 Might.enableSyntaxHighlighting("JScript") ;
//-->
</script><script src="By%20example:%20Continuation-passing%20style%20in%20JavaScript_files/xregexp-min.js"></script><script src="By%20example:%20Continuation-passing%20style%20in%20JavaScript_files/shCore.js"></script><script src="By%20example:%20Continuation-passing%20style%20in%20JavaScript_files/shBrushJScript.js"></script><link rel="stylesheet" type="text/css" media="all" href="By%20example:%20Continuation-passing%20style%20in%20JavaScript_files/shCore.css"><link rel="stylesheet" type="text/css" media="all" href="By%20example:%20Continuation-passing%20style%20in%20JavaScript_files/shThemeDefault.css">


<h2>What is continuation-passing style?</h2>

<p> If a language supports continuations, the programmer can add control
constructs like exceptions, backtracking, threads and generators. </p>

<p> Sadly, many explanations of continuations 
 (<a href="http://matt.might.net/articles/programming-with-continuations--exceptions-backtracking-search-threads-generators-coroutines/">mine
included</a>) feel vague and unsatisfying. 

Such power deserves a solid pedagogical foundation.
</p>

<p>
Continuation-passing style is that foundation.
</p>

<p> Continuation-passing style gives continuations meaning in terms of code.
</p>


<p> Even better, a programmer can discover continuation-passing style 
by themselves if subjected to one constraint: </p>

<p style="text-align: center;">
 <em>No procedure is allowed to return to its caller--ever.</em>
</p>

<p>
One hint makes programming in this style possible:
</p>

<p style="text-align: center;">
 <em>Procedures can take a callback to invoke upon their return value.</em>
</p>

<p> When a procedure is ready to "return" to its caller, it invokes the
"current continuation" callback (provided by its caller) on the return value.
</p>


<p>
A continuation is a first-class return point. 
</p>




<h3>Example: Identity function</h3>

<p>
Consider the identity function written normally:
</p>

<div><div id="highlighter_187728" class="syntaxhighlighter nogutter  js"><table border="0" cellspacing="0" cellpadding="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">function</code> <code class="js plain">id(x) {</code></div><div class="line number2 index1 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">return</code> <code class="js plain">x ;</code></div><div class="line number3 index2 alt2"><code class="js plain">}</code></div></div></td></tr></tbody></table></div></div>

<p>
and then in continuation-passing style:
</p>

<div><div id="highlighter_728459" class="syntaxhighlighter nogutter  js"><table border="0" cellspacing="0" cellpadding="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">function</code> <code class="js plain">id(x,cc) {</code></div><div class="line number2 index1 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">cc(x) ;</code></div><div class="line number3 index2 alt2"><code class="js plain">}</code></div></div></td></tr></tbody></table></div></div>

<p>
Sometimes, calling the current continuation argument <code>ret</code> makes its purpose more obvious:
</p>

<div><div id="highlighter_495271" class="syntaxhighlighter nogutter  js"><table border="0" cellspacing="0" cellpadding="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">function</code> <code class="js plain">id(x,ret) {</code></div><div class="line number2 index1 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">ret(x) ;</code></div><div class="line number3 index2 alt2"><code class="js plain">}</code></div></div></td></tr></tbody></table></div></div>



<h3>Example: Naive factorial</h3>

<p>
Here's the standard naive factorial:
</p>

<div><div id="highlighter_88631" class="syntaxhighlighter nogutter  js"><table border="0" cellspacing="0" cellpadding="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">function</code> <code class="js plain">fact(n) {</code></div><div class="line number2 index1 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">if</code> <code class="js plain">(n == 0)</code></div><div class="line number3 index2 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js keyword">return</code> <code class="js plain">1 ;</code></div><div class="line number4 index3 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">else</code></div><div class="line number5 index4 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js keyword">return</code> <code class="js plain">n * fact(n-1) ;</code></div><div class="line number6 index5 alt1"><code class="js plain">}</code></div></div></td></tr></tbody></table></div></div>

<p>
Here it is in CPS:
</p>

<div><div id="highlighter_71370" class="syntaxhighlighter nogutter  js"><table border="0" cellspacing="0" cellpadding="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">function</code> <code class="js plain">fact(n,ret) {</code></div><div class="line number2 index1 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">if</code> <code class="js plain">(n == 0)</code></div><div class="line number3 index2 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">ret(1) ;</code></div><div class="line number4 index3 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">else</code></div><div class="line number5 index4 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">fact(n-1, </code><code class="js keyword">function</code> <code class="js plain">(t0) {</code></div><div class="line number6 index5 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">ret(n * t0) }) ;</code></div><div class="line number7 index6 alt2"><code class="js plain">}</code></div></div></td></tr></tbody></table></div></div>


<p>
And, to "use" the function, we pass it a callback:
</p>

<div><div id="highlighter_328336" class="syntaxhighlighter nogutter  js"><table border="0" cellspacing="0" cellpadding="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js plain">fact (5, </code><code class="js keyword">function</code> <code class="js plain">(n) { </code></div><div class="line number2 index1 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">console.log(n) ; </code><code class="js comments">// Prints 120 in Firebug.</code></div><div class="line number3 index2 alt2"><code class="js plain">})</code></div></div></td></tr></tbody></table></div></div>



<h3>Example: Tail-recursive factorial</h3>

<p>
Here's tail-recursive factorial:
</p>

<div><div id="highlighter_953173" class="syntaxhighlighter nogutter  js"><table border="0" cellspacing="0" cellpadding="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">function</code> <code class="js plain">fact(n) {</code></div><div class="line number2 index1 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">return</code> <code class="js plain">tail_fact(n,1) ;</code></div><div class="line number3 index2 alt2"><code class="js plain">}</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="js keyword">function</code> <code class="js plain">tail_fact(n,a) {</code></div><div class="line number6 index5 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">if</code> <code class="js plain">(n == 0)</code></div><div class="line number7 index6 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js keyword">return</code> <code class="js plain">a ;</code></div><div class="line number8 index7 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">else</code></div><div class="line number9 index8 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js keyword">return</code> <code class="js plain">tail_fact(n-1,n*a) ;</code></div><div class="line number10 index9 alt1"><code class="js plain">}</code></div></div></td></tr></tbody></table></div></div>


<p>
And, in CPS:
</p>

<div><div id="highlighter_119308" class="syntaxhighlighter nogutter  js"><table border="0" cellspacing="0" cellpadding="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">function</code> <code class="js plain">fact(n,ret) {</code></div><div class="line number2 index1 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">tail_fact(n,1,ret) ;</code></div><div class="line number3 index2 alt2"><code class="js plain">} </code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="js keyword">function</code> <code class="js plain">tail_fact(n,a,ret) {</code></div><div class="line number6 index5 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">if</code> <code class="js plain">(n == 0)</code></div><div class="line number7 index6 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">ret(a) ;</code></div><div class="line number8 index7 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">else</code></div><div class="line number9 index8 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">tail_fact(n-1,n*a,ret) ;</code></div><div class="line number10 index9 alt1"><code class="js plain">}</code></div></div></td></tr></tbody></table></div></div>


<h2>CPS and Ajax</h2>

<p> Ajax is a web programming technique which uses an
<code>XMLHttpRequest</code> object in JavaScript to fetch data
(asynchronously) from a server.  </p>

<p>
(That data need not be XML.)
</p>


<p>
CPS provides an elegant way to do Ajax programming.
</p>

<p> With <code>XMLHttpRequest</code>, we <em>could</em> write a blocking procedure
<code>fetch(<i>url</i>)</code> that grabs the contents of a url as a string, and then returns it.</p>

<p> The problem with this approach is that JavaScript is a single-threaded
language, and when JavaScript blocks, the browser is momentarily frozen.
</p>

<p>
It makes for an unpleasant user experience.
</p>

<p> A better approach is a procedure
<code>fetch(<i>url</i>,<i>callback</i>)</code> which allows execution (or
browser rendering) to continue, and calls the provided callback once the
request is completed.  </p>


<p>
In this approach, partial CPS-conversion becomes a natural way to code.
</p>

<h3>Implementing <code>fetch</code></h3>

<p> It's not hard to implement <code>fetch</code> so that it operates in non-blocking mode
or blocking mode, depending on whether the programmer supplied a callback: </p>

<div><div id="highlighter_692760" class="syntaxhighlighter nogutter  js"><table border="0" cellspacing="0" cellpadding="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js comments">/*</code></div><div class="line number2 index1 alt1"><code class="js spaces">&nbsp;</code><code class="js comments">fetch is an optionally-blocking </code></div><div class="line number3 index2 alt2"><code class="js spaces">&nbsp;</code><code class="js comments">procedure for client-&gt;server requests.</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="js spaces">&nbsp;</code><code class="js comments">If only a url is given, the procedure </code></div><div class="line number6 index5 alt1"><code class="js spaces">&nbsp;</code><code class="js comments">blocks and returns the contents of the url.</code></div><div class="line number7 index6 alt2">&nbsp;</div><div class="line number8 index7 alt1"><code class="js spaces">&nbsp;</code><code class="js comments">If an onSuccess callback is provided, </code></div><div class="line number9 index8 alt2"><code class="js spaces">&nbsp;</code><code class="js comments">the procedure is non-blocking, and the</code></div><div class="line number10 index9 alt1"><code class="js spaces">&nbsp;</code><code class="js comments">callback is invoked with the contents </code></div><div class="line number11 index10 alt2"><code class="js spaces">&nbsp;</code><code class="js comments">of the file.</code></div><div class="line number12 index11 alt1">&nbsp;</div><div class="line number13 index12 alt2"><code class="js spaces">&nbsp;</code><code class="js comments">If an onFail callback is also provided, </code></div><div class="line number14 index13 alt1"><code class="js spaces">&nbsp;</code><code class="js comments">the procedure calls onFail in the event of </code></div><div class="line number15 index14 alt2"><code class="js spaces">&nbsp;</code><code class="js comments">a failure.</code></div><div class="line number16 index15 alt1">&nbsp;</div><div class="line number17 index16 alt2"><code class="js comments">*/</code></div><div class="line number18 index17 alt1">&nbsp;</div><div class="line number19 index18 alt2"><code class="js keyword">function</code> <code class="js plain">fetch (url, onSuccess, onFail) {</code></div><div class="line number20 index19 alt1">&nbsp;</div><div class="line number21 index20 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">// Async only if a callback is defined: </code></div><div class="line number22 index21 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">var</code> <code class="js plain">async = onSuccess ? </code><code class="js keyword">true</code> <code class="js plain">: </code><code class="js keyword">false</code> <code class="js plain">;</code></div><div class="line number23 index22 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">// (Don't complain about the inefficiency</code></div><div class="line number24 index23 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//&nbsp; of this line; you're missing the point.)</code></div><div class="line number25 index24 alt2">&nbsp;</div><div class="line number26 index25 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">var</code> <code class="js plain">req ; </code><code class="js comments">// XMLHttpRequest object.</code></div><div class="line number27 index26 alt2">&nbsp;</div><div class="line number28 index27 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">// The XMLHttpRequest callback:</code></div><div class="line number29 index28 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">function</code> <code class="js plain">processReqChange() {</code></div><div class="line number30 index29 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js keyword">if</code> <code class="js plain">(req.readyState == 4) {</code></div><div class="line number31 index30 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js keyword">if</code> <code class="js plain">(req.status == 200) {</code></div><div class="line number32 index31 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js keyword">if</code> <code class="js plain">(onSuccess) </code></div><div class="line number33 index32 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">onSuccess(req.responseText, url, req) ; </code></div><div class="line number34 index33 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">} </code><code class="js keyword">else</code> <code class="js plain">{</code></div><div class="line number35 index34 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js keyword">if</code> <code class="js plain">(onFail) </code></div><div class="line number36 index35 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">onFail(url, req) ;</code></div><div class="line number37 index36 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">}</code></div><div class="line number38 index37 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">}</code></div><div class="line number39 index38 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">}</code></div><div class="line number40 index39 alt1">&nbsp;</div><div class="line number41 index40 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">// Create the XMLHttpRequest object:</code></div><div class="line number42 index41 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">if</code> <code class="js plain">(window.XMLHttpRequest) </code></div><div class="line number43 index42 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">req = </code><code class="js keyword">new</code> <code class="js plain">XMLHttpRequest();</code></div><div class="line number44 index43 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">else</code> <code class="js keyword">if</code> <code class="js plain">(window.ActiveXObject) </code></div><div class="line number45 index44 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">req = </code><code class="js keyword">new</code> <code class="js plain">ActiveXObject(</code><code class="js string">"Microsoft.XMLHTTP"</code><code class="js plain">);</code></div><div class="line number46 index45 alt1">&nbsp;</div><div class="line number47 index46 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">// If asynchronous, set the callback:</code></div><div class="line number48 index47 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">if</code> <code class="js plain">(async) </code></div><div class="line number49 index48 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">req.onreadystatechange = processReqChange;</code></div><div class="line number50 index49 alt1">&nbsp;</div><div class="line number51 index50 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">// Fire off the request:</code></div><div class="line number52 index51 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">req.open(</code><code class="js string">"GET"</code><code class="js plain">, url, async);</code></div><div class="line number53 index52 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">req.send(</code><code class="js keyword">null</code><code class="js plain">);</code></div><div class="line number54 index53 alt1">&nbsp;</div><div class="line number55 index54 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">// If asynchronous,</code></div><div class="line number56 index55 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//&nbsp; return request object; or else</code></div><div class="line number57 index56 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//&nbsp; return the response.</code></div><div class="line number58 index57 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">if</code> <code class="js plain">(async) </code></div><div class="line number59 index58 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js keyword">return</code> <code class="js plain">req ;</code></div><div class="line number60 index59 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">else</code></div><div class="line number61 index60 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js keyword">return</code> <code class="js plain">req.responseText ;</code></div><div class="line number62 index61 alt1"><code class="js plain">} </code></div></div></td></tr></tbody></table></div></div>



<h3>Example: Fetching data</h3>

<p>
Consider a program that needs to grab a name for a UID.
</p>

<p>
Using <code>fetch</code>, both of the following work:
</p>

<div><div id="highlighter_851512" class="syntaxhighlighter nogutter  js"><table border="0" cellspacing="0" cellpadding="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js comments">// Blocks until request in finished:</code></div><div class="line number2 index1 alt1"><code class="js keyword">var</code> <code class="js plain">someName = fetch(</code><code class="js string">"./1031/name"</code><code class="js plain">) ;</code></div><div class="line number3 index2 alt2">&nbsp;</div><div class="line number4 index3 alt1"><code class="js plain">document.write (</code><code class="js string">"someName: "</code> <code class="js plain">+ someName + </code><code class="js string">"&lt;br&gt;"</code><code class="js plain">) ;</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="js comments">// Does not block:</code></div><div class="line number7 index6 alt2"><code class="js plain">fetch(</code><code class="js string">"./1030/name"</code><code class="js plain">, </code><code class="js keyword">function</code> <code class="js plain">(name) {</code></div><div class="line number8 index7 alt1"><code class="js spaces">&nbsp;</code><code class="js plain">document.getElementById(</code><code class="js string">"name"</code><code class="js plain">).innerHTML = name ;</code></div><div class="line number9 index8 alt2"><code class="js plain">}) ;</code></div></div></td></tr></tbody></table></div></div>

(See <a href="http://matt.might.net/articles/by-example-continuation-passing-style/code/client.html">the example</a>.)


<h2>CPS and non-blocking programming</h2>

<p> <a href="http://nodejs.org/">node.js</a> is a high-performance, server-side
platform for JavaScript in which blocking procedures are banned.  </p>

<p> Cleverly, procedures which ordinarily would block (e.g. network or file
I/O) take a <em>callback</em> that to be invoked with the result.  </p>

<p> Partially CPS-converting a program makes for natural node.js 
programming.</p>


<h3>Example: Simple web server</h3>

<p>
A simple web server in node.js passes a continuation to the file-reading procedure.

Compared to the <code>select</code>-based approach to non-blocking IO, CPS
makes non-blocking I/O straightforward.  </p>

<div><div id="highlighter_486138" class="syntaxhighlighter nogutter  js"><table border="0" cellspacing="0" cellpadding="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">var</code> <code class="js plain">sys = require(</code><code class="js string">'sys'</code><code class="js plain">) ;</code></div><div class="line number2 index1 alt1"><code class="js keyword">var</code> <code class="js plain">http = require(</code><code class="js string">'http'</code><code class="js plain">) ;</code></div><div class="line number3 index2 alt2"><code class="js keyword">var</code> <code class="js plain">url = require(</code><code class="js string">'url'</code><code class="js plain">) ;</code></div><div class="line number4 index3 alt1"><code class="js keyword">var</code> <code class="js plain">fs = require(</code><code class="js string">'fs'</code><code class="js plain">) ;</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="js comments">// Web server root:</code></div><div class="line number7 index6 alt2"><code class="js keyword">var</code> <code class="js plain">DocRoot = </code><code class="js string">"./www/"</code> <code class="js plain">;</code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="js comments">// Create the web server with a handler callback:</code></div><div class="line number10 index9 alt1"><code class="js keyword">var</code> <code class="js plain">httpd = http.createServer(</code><code class="js keyword">function</code> <code class="js plain">(req, res) {</code></div><div class="line number11 index10 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">sys.puts(</code><code class="js string">" request: "</code> <code class="js plain">+ req.url) ;</code></div><div class="line number12 index11 alt1">&nbsp;</div><div class="line number13 index12 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">// Parse the url:</code></div><div class="line number14 index13 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">var</code> <code class="js plain">u = url.parse(req.url,</code><code class="js keyword">true</code><code class="js plain">) ;</code></div><div class="line number15 index14 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">var</code> <code class="js plain">path = u.pathname.split(</code><code class="js string">"/"</code><code class="js plain">) ;</code></div><div class="line number16 index15 alt1">&nbsp;</div><div class="line number17 index16 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">// Strip out .. in the path:</code></div><div class="line number18 index17 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">var</code> <code class="js plain">localPath = u.pathname ;</code></div><div class="line number19 index18 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//&nbsp; "&lt;dir&gt;/.." =&gt; ""</code></div><div class="line number20 index19 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">var</code> <code class="js plain">localPath = </code></div><div class="line number21 index20 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">localPath.replace(/[^/]+\/+[.][.]/g,</code><code class="js string">""</code><code class="js plain">) ;</code></div><div class="line number22 index21 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//&nbsp; ".." =&gt; "."</code></div><div class="line number23 index22 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">var</code> <code class="js plain">localPath = DocRoot +&nbsp; </code></div><div class="line number24 index23 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">localPath.replace(/[.][.]/g,</code><code class="js string">"."</code><code class="js plain">) ;</code></div><div class="line number25 index24 alt2">&nbsp;</div><div class="line number26 index25 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">sys.puts(</code><code class="js string">" local path: "</code> <code class="js plain">+ localPath) ;</code></div><div class="line number27 index26 alt2"><code class="js spaces">&nbsp;&nbsp;</code>&nbsp;</div><div class="line number28 index27 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">// Read in the requested file, and send it back.</code></div><div class="line number29 index28 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">// Note: readFile takes the current continuation:</code></div><div class="line number30 index29 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">fs.readFile(localPath, </code><code class="js keyword">function</code> <code class="js plain">(err,data) {</code></div><div class="line number31 index30 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js keyword">var</code> <code class="js plain">headers = {} ;</code></div><div class="line number32 index31 alt1">&nbsp;</div><div class="line number33 index32 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js keyword">if</code> <code class="js plain">(err) {</code></div><div class="line number34 index33 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">headers[</code><code class="js string">"Content-Type"</code><code class="js plain">] = </code><code class="js string">"text/plain"</code> <code class="js plain">;</code></div><div class="line number35 index34 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">res.writeHead(404, headers);</code></div><div class="line number36 index35 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">res.write(</code><code class="js string">"404 File Not Found\n"</code><code class="js plain">) ;</code></div><div class="line number37 index36 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">res.end() ;&nbsp; </code></div><div class="line number38 index37 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">} </code><code class="js keyword">else</code> <code class="js plain">{</code></div><div class="line number39 index38 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js keyword">var</code> <code class="js plain">mimetype = MIMEType(u.pathname) ;</code></div><div class="line number40 index39 alt1">&nbsp;</div><div class="line number41 index40 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">// If we can't find a content type, </code></div><div class="line number42 index41 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js comments">// let the client guess.</code></div><div class="line number43 index42 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js keyword">if</code> <code class="js plain">(mimetype)</code></div><div class="line number44 index43 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">headers[</code><code class="js string">"Content-Type"</code><code class="js plain">] = mimetype ;</code></div><div class="line number45 index44 alt2">&nbsp;</div><div class="line number46 index45 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">res.writeHead(200, headers) ;</code></div><div class="line number47 index46 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">res.write(data) ;</code></div><div class="line number48 index47 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">res.end() ;&nbsp;&nbsp; </code></div><div class="line number49 index48 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">}</code></div><div class="line number50 index49 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;</code><code class="js plain">}) ;</code></div><div class="line number51 index50 alt2"><code class="js plain">}) ;</code></div><div class="line number52 index51 alt1">&nbsp;</div><div class="line number53 index52 alt2"><code class="js comments">// Map extensions to MIME Types:</code></div><div class="line number54 index53 alt1"><code class="js keyword">var</code> <code class="js plain">MIMETypes = {</code></div><div class="line number55 index54 alt2"><code class="js spaces">&nbsp;</code><code class="js string">"html"</code> <code class="js plain">: </code><code class="js string">"text/html"</code> <code class="js plain">,</code></div><div class="line number56 index55 alt1"><code class="js spaces">&nbsp;</code><code class="js string">"js"</code>&nbsp;&nbsp; <code class="js plain">: </code><code class="js string">"text/javascript"</code> <code class="js plain">,</code></div><div class="line number57 index56 alt2"><code class="js spaces">&nbsp;</code><code class="js string">"css"</code>&nbsp; <code class="js plain">: </code><code class="js string">"text/css"</code> <code class="js plain">,</code></div><div class="line number58 index57 alt1"><code class="js spaces">&nbsp;</code><code class="js string">"txt"</code>&nbsp; <code class="js plain">: </code><code class="js string">"text/plain"</code></div><div class="line number59 index58 alt2"><code class="js plain">} ;</code></div><div class="line number60 index59 alt1">&nbsp;</div><div class="line number61 index60 alt2"><code class="js keyword">function</code> <code class="js plain">MIMEType(filename) {</code></div><div class="line number62 index61 alt1"><code class="js spaces">&nbsp;</code><code class="js keyword">var</code> <code class="js plain">parsed = filename.match(/[.](.*)$/) ;</code></div><div class="line number63 index62 alt2"><code class="js spaces">&nbsp;</code><code class="js keyword">if</code> <code class="js plain">(!parsed)</code></div><div class="line number64 index63 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;</code><code class="js keyword">return</code> <code class="js keyword">false</code> <code class="js plain">;</code></div><div class="line number65 index64 alt2"><code class="js spaces">&nbsp;</code><code class="js keyword">var</code> <code class="js plain">ext = parsed[1] ;</code></div><div class="line number66 index65 alt1"><code class="js spaces">&nbsp;</code><code class="js keyword">return</code> <code class="js plain">MIMETypes[ext] ;</code></div><div class="line number67 index66 alt2"><code class="js plain">}</code></div><div class="line number68 index67 alt1">&nbsp;</div><div class="line number69 index68 alt2"><code class="js comments">// Start the server, listening to port 8000:</code></div><div class="line number70 index69 alt1"><code class="js plain">httpd.listen(8000) ;</code></div></div></td></tr></tbody></table></div></div>



<h2>CPS for distributed computation</h2>

<p> CPS eases factoring a computation into local and
distributed portions.  </p>

<p> Suppose you wrote the combinatorial choose function; first normally: </p>

<div><div id="highlighter_698067" class="syntaxhighlighter nogutter  js"><table border="0" cellspacing="0" cellpadding="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">function</code> <code class="js plain">choose (n,k) {</code></div><div class="line number2 index1 alt1"><code class="js spaces">&nbsp;</code><code class="js keyword">return</code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <code class="js plain">fact(n) / </code></div><div class="line number3 index2 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">(fact(k) * fact(n-k)) ;&nbsp;&nbsp; </code></div><div class="line number4 index3 alt1"><code class="js plain">}</code></div></div></td></tr></tbody></table></div></div>

<p>
Now, suppose you want to compute factorial on a server, instead of locally.
</p>

<p> You could rewrite <code>fact</code> to block and wait
for the server to respond.  </p>

<p>
That's bad.
</p>

<p>
Instead, assume you wrote <code>choose</code> in CPS:
</p>

<div><div id="highlighter_742315" class="syntaxhighlighter nogutter  js"><table border="0" cellspacing="0" cellpadding="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">function</code> <code class="js plain">choose(n,k,ret) {</code></div><div class="line number2 index1 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">fact (n,&nbsp;&nbsp; </code><code class="js keyword">function</code> <code class="js plain">(factn) {</code></div><div class="line number3 index2 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">fact (n-k, </code><code class="js keyword">function</code> <code class="js plain">(factnk) {</code></div><div class="line number4 index3 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">fact (k,&nbsp;&nbsp; </code><code class="js keyword">function</code> <code class="js plain">(factk) {</code></div><div class="line number5 index4 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">ret&nbsp; (factn / (factnk * factk)) }) }) }) </code></div><div class="line number6 index5 alt1"><code class="js plain">}</code></div></div></td></tr></tbody></table></div></div>

<p>
Now, it's straightforward to redefine <code>fact</code>
to asynchronously compute factorial on the server:
</p>

<div><div id="highlighter_89610" class="syntaxhighlighter nogutter  js"><table border="0" cellspacing="0" cellpadding="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">function</code> <code class="js plain">fact(n,ret) {</code></div><div class="line number2 index1 alt1"><code class="js spaces">&nbsp;</code><code class="js plain">fetch (</code><code class="js string">"./fact/"</code> <code class="js plain">+ n, </code><code class="js keyword">function</code> <code class="js plain">(res) {</code></div><div class="line number3 index2 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;</code><code class="js plain">ret(eval(res))</code></div><div class="line number4 index3 alt1"><code class="js spaces">&nbsp;</code><code class="js plain">}) ;</code></div><div class="line number5 index4 alt2"><code class="js plain">}</code></div></div></td></tr></tbody></table></div></div>

<p>
(Fun exercise: modify the node.js server so that this works.)
</p>



<h2>Implementing exceptions in CPS</h2>

<p>
Once a program is in CPS, it breaks the standard exception mechanisms in the language.

Fortunately, it's easy to implement exceptions in CPS.
</p>

<p>
An exception is a special case of a continuation.
</p>


<p> By passing the current exceptional continuation alongside the current
continuation, one can desugar try/catch blocks. </p>


<p> Consider the following example, which uses exceptions to define a "total"
version of factorial: </p>

<div><div id="highlighter_540876" class="syntaxhighlighter nogutter  js"><table border="0" cellspacing="0" cellpadding="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">function</code> <code class="js plain">fact (n) {</code></div><div class="line number2 index1 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">if</code> <code class="js plain">(n &lt; 0)</code></div><div class="line number3 index2 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js keyword">throw</code> <code class="js string">"n &lt; 0"</code> <code class="js plain">;</code></div><div class="line number4 index3 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">else</code> <code class="js keyword">if</code> <code class="js plain">(n == 0)</code></div><div class="line number5 index4 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js keyword">return</code> <code class="js plain">1 ;</code></div><div class="line number6 index5 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">else</code></div><div class="line number7 index6 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js keyword">return</code> <code class="js plain">n * fact(n-1) ;</code></div><div class="line number8 index7 alt1"><code class="js plain">}</code></div><div class="line number9 index8 alt2">&nbsp;</div><div class="line number10 index9 alt1"><code class="js keyword">function</code> <code class="js plain">total_fact (n) {</code></div><div class="line number11 index10 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">try</code> <code class="js plain">{</code></div><div class="line number12 index11 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js keyword">return</code> <code class="js plain">fact(n) ;</code></div><div class="line number13 index12 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">} </code><code class="js keyword">catch</code> <code class="js plain">(ex) {</code></div><div class="line number14 index13 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js keyword">return</code> <code class="js keyword">false</code> <code class="js plain">;</code></div><div class="line number15 index14 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">}</code></div><div class="line number16 index15 alt1"><code class="js plain">}</code></div><div class="line number17 index16 alt2">&nbsp;</div><div class="line number18 index17 alt1"><code class="js plain">document.write(</code><code class="js string">"total_fact(10): "</code> <code class="js plain">+ total_fact(10)) ;</code></div><div class="line number19 index18 alt2"><code class="js plain">document.write(</code><code class="js string">"total_fact(-1): "</code> <code class="js plain">+ total_fact(-1)) ;</code></div></div></td></tr></tbody></table></div></div>


<p> By adding an exceptional continuation in CPS, we can desugar the
<code>throw</code>, <code>try</code> and <code>catch</code>:  </p>

<div><div id="highlighter_490816" class="syntaxhighlighter nogutter  js"><table border="0" cellspacing="0" cellpadding="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">function</code> <code class="js plain">fact (n,ret,thro) {</code></div><div class="line number2 index1 alt1"><code class="js spaces">&nbsp;</code><code class="js keyword">if</code> <code class="js plain">(n &lt; 0)</code></div><div class="line number3 index2 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;</code><code class="js plain">thro(</code><code class="js string">"n &lt; 0"</code><code class="js plain">) </code></div><div class="line number4 index3 alt1"><code class="js spaces">&nbsp;</code><code class="js keyword">else</code> <code class="js keyword">if</code> <code class="js plain">(n == 0)</code></div><div class="line number5 index4 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;</code><code class="js plain">ret(1)</code></div><div class="line number6 index5 alt1"><code class="js spaces">&nbsp;</code><code class="js keyword">else</code></div><div class="line number7 index6 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;</code><code class="js plain">fact(n-1,</code></div><div class="line number8 index7 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js keyword">function</code> <code class="js plain">(t0) {</code></div><div class="line number9 index8 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">ret(n*t0) ;</code></div><div class="line number10 index9 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">},</code></div><div class="line number11 index10 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">thro)</code></div><div class="line number12 index11 alt1"><code class="js plain">}</code></div><div class="line number13 index12 alt2">&nbsp;</div><div class="line number14 index13 alt1"><code class="js keyword">function</code> <code class="js plain">total_fact (n,ret) {</code></div><div class="line number15 index14 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">fact (n,ret,</code></div><div class="line number16 index15 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js keyword">function</code> <code class="js plain">(ex) {</code></div><div class="line number17 index16 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">ret(</code><code class="js keyword">false</code><code class="js plain">) ;</code></div><div class="line number18 index17 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">}) ;</code></div><div class="line number19 index18 alt2"><code class="js plain">}</code></div><div class="line number20 index19 alt1">&nbsp;</div><div class="line number21 index20 alt2"><code class="js plain">total_fact(10, </code><code class="js keyword">function</code> <code class="js plain">(res) {</code></div><div class="line number22 index21 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">document.write(</code><code class="js string">"total_fact(10): "</code> <code class="js plain">+ res)</code></div><div class="line number23 index22 alt2"><code class="js plain">}) ;</code></div><div class="line number24 index23 alt1">&nbsp;</div><div class="line number25 index24 alt2"><code class="js plain">total_fact(-1, </code><code class="js keyword">function</code> <code class="js plain">(res) {</code></div><div class="line number26 index25 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">document.write(</code><code class="js string">"total_fact(-1): "</code> <code class="js plain">+ res)</code></div><div class="line number27 index26 alt2"><code class="js plain">}) ;</code></div></div></td></tr></tbody></table></div></div>




<h2>CPS for compilation</h2>

<p> For three decades, CPS has been a powerful intermediate representation for
compilers of functional programming languages.  </p>


<p> CPS desugars function return, exceptions and first-class
continuations; function call turns into a single jump instruction. 
</p>

<p>
In other words, CPS does a lot of the heavy lifting in compilation.
</p>


<h3>Translating the lambda calculus to CPS</h3>

<p> The lambda calculus is a miniature Lisp, with just enough expressions
(applications, anonymous functions and variable references) to make it
universal for computation:  </p>

<pre> <i>exp</i> ::= (<i>exp</i> <i>exp</i>)           ; function application
      |  (lambda (<i>var</i>) <i>exp</i>)  ; anonymous function
      |  <i>var</i>                 ; variable reference
</pre>

<p> The following Racket code converts this language into
CPS: </p>

<pre>(define (cps-convert term cont)
  (match term
    [`(,f ,e)
     ; =&gt;
     (let (($f (gensym 'f))
           ($e (gensym 'e)))
       (cps-convert f `(lambda (,$f)
         ,(cps-convert e `(lambda (,$e)
             (,$f ,$e ,cont))))))]
    
    [`(lambda (,v) ,e)
     ; =&gt;
     (let (($k (gensym 'k)))
       `(,cont (lambda (,v ,$k)
                 ,(cps-convert e $k))))]
    
    [(? symbol?)
     ; =&gt;
     `(,cont ,term)]))

(define (cps-convert-program term)
  (cps-convert term '(lambda (ans) ans)))
</pre>


<p>
For those interested, 
<a href="http://www.brics.dk/%7Edanvy/">Olivier Danvy</a> has plenty of papers on writing efficient CPS converters.
</p>


<h2>Implementing <code>call/cc</code> in Lisp</h2>

<p> The primitive <code>call-with-current-continuation</code> (commonly called
<code>call/cc</code>) is the most powerful control-flow construct in
modern programming.  </p>


<p>
CPS makes implementing <code>call/cc</code> trivial;
it's a syntactic desugaring:
</p>

<pre> call/cc =&gt; (lambda (f cc) (f (lambda (x k) (cc x)) cc))
</pre>

<p> This desugaring (in conjunction with the CPS transformation) is
the best way to understand exactly what <code>call/cc</code> does.
</p>

<p> It does exactly what it's name says it will: it calls the procedure
given as an argument with a procedure that has captured the current
continuation.
</p>

<p> When that procedure capturing the continuation gets invoked, it "returns"
the computation to the point at which the computation was created.  </p>



<h2>Implementing <code>call/cc</code> in JavaScript</h2>

<p> If one were to translate to continuation-passing style in JavaScript,
<code>call/cc</code> has a simple definition: </p>

<pre>function callcc (f,cc) { 
  f(function(x,k) { cc(x) },cc)
}
</pre>




<h2>More resources</h2>

<ul>
 <li>
<a href="http://www.amazon.com/gp/product/0596101996?ie=UTF8&amp;tag=ucmbread-20&amp;linkCode=as2&amp;camp=1789&amp;creative=390957&amp;creativeASIN=0596101996">JavaScript: The Definitive Guide</a><img src="By%20example:%20Continuation-passing%20style%20in%20JavaScript_files/ir_003.gif" alt="" style="border:none !important; margin:0px !important;" border="0" height="1" width="1">, 
 the best book on JavaScript.</li>
 
 <li>
<a href="http://www.amazon.com/gp/product/0596517742?ie=UTF8&amp;tag=ucmbread-20&amp;linkCode=as2&amp;camp=1789&amp;creative=390957&amp;creativeASIN=0596517742">JavaScript: The Good Parts</a><img src="By%20example:%20Continuation-passing%20style%20in%20JavaScript_files/ir.gif" alt="" style="border:none !important; margin:0px !important;" border="0" height="1" width="1">, the only other good JavaScript book. 
 </li>

 <li>Andrew Appel's timeless classic 
<a href="http://www.amazon.com/gp/product/052103311X?ie=UTF8&amp;tag=ucmbread-20&amp;linkCode=as2&amp;camp=1789&amp;creative=390957&amp;creativeASIN=052103311X">Compiling with Continuations</a><img src="By%20example:%20Continuation-passing%20style%20in%20JavaScript_files/ir_002.gif" alt="" style="border:none !important; margin:0px !important;" border="0" height="1" width="1">.

 </li>

 <li>
 <a href="http://library.readscheme.org/page1.html">The Lambda Papers</a>.
 </li>

 <li>My post on <a href="http://matt.might.net/articles/programming-with-continuations--exceptions-backtracking-search-threads-generators-coroutines/">programming with continuations by example</a>.</li>

 <li><a href="http://faculty.cs.byu.edu/%7Ejay/home/">Jay McCarthy</a> <em>et al.</em>'s papers on a continuation-based web-server.</li>
</ul>


<script type="text/javascript">
<!--
 SyntaxHighlighter.all() ;
//-->
</script>
  

 <hr>

 <div id="footer-links">
 [<a href="http://matt.might.net/articles/">article index</a>]
 [<script>
       var emailMatt = '<a href="mai'+'lto:matt-blog'+'@'+'migh'+'t.net">email me</a>'
document.write(emailMatt);
 //-->
</script><a href="mailto:matt-blog@might.net">email me</a>] 
 [<a href="http://twitter.com/mattmight">@mattmight</a>]
 [<a href="http://gplus.to/mattmight">+mattmight</a>]
 [<a href="http://matt.might.net/articles/feed.rss">rss</a>]
 </div>


  
</div> <!-- /#content -->
</div> <!-- /#content-container -->



<div id="footer-ad" class="module fat-container">
 <div class="fat-content">

<center>
<script type="text/javascript"><!--
google_ad_client = "pub-4400645483943138";
/* Article footer banner */
google_ad_slot = "3531754286";
google_ad_width = 468;
google_ad_height = 60;
//-->
</script>
<script type="text/javascript" src="By%20example:%20Continuation-passing%20style%20in%20JavaScript_files/show_ads.js">
</script><ins id="aswift_1_expand" style="display:inline-table;border:none;height:60px;margin:0;padding:0;position:relative;visibility:visible;width:468px;background-color:transparent"><ins id="aswift_1_anchor" style="display:block;border:none;height:60px;margin:0;padding:0;position:relative;visibility:visible;width:468px;background-color:transparent"><iframe marginwidth="0" marginheight="0" vspace="0" hspace="0" allowtransparency="true" scrolling="no" allowfullscreen="true" onload="var i=this.id,s=window.google_iframe_oncopy,H=s&amp;&amp;s.handlers,h=H&amp;&amp;H[i],w=this.contentWindow,d;try{d=w.document}catch(e){}if(h&amp;&amp;d&amp;&amp;(!d.body||!d.body.firstChild)){if(h.call){setTimeout(h,0)}else if(h.match){try{h=s.upd(h,i)}catch(e){}w.location.replace(h)}}" id="aswift_1" name="aswift_1" style="left:0;position:absolute;top:0;" frameborder="0" height="60" width="468"></iframe></ins></ins>
   </center>
 </div> <!-- /footer-ad -->
</div><div class="navlinks"><b>Latest:</b> <a href="http://matt.might.net/articles/tenure/">HOWTO: Get tenure</a><br><b>Next:</b> <a href="http://matt.might.net/articles/red-black-delete/">Deleting from Okasaki's red-black trees</a><br><b>Prev:</b> <a href="http://matt.might.net/articles/problem-shapes/">The shape of your problem</a><br><b>Rand:</b> <a href="http://matt.might.net/articles/perl-by-example/">Learn Perl by experiment</a></div> <!-- /footer-ad-container -->





<div id="footer-linode" class="module fat-container">
 <div class="fat-content"> 
 <center>
 matt.might.net is powered by <b><a href="http://www.linode.com/?r=bf5d4e7c8a1af61855b5227279a6744c3bde8a8a">linode</a></b> | 
   <a href="http://matt.might.net/articles/legal/">legal information</a>
 </center>
 </div>
</div>






</div> <!-- /#body -->






<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script><script src="By%20example:%20Continuation-passing%20style%20in%20JavaScript_files/ga.js" type="text/javascript"></script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-3661244-1");
pageTracker._trackPageview();
</script>







</body></html>